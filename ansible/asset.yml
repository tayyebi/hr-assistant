---
- name: Get assets page
  uri:
    url: "http://app:8080/assets"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: assets_page

- name: Assert assets page loaded
  assert:
    that:
      - assets_page.status == 200

- name: Ensure provider instance id is available (fetch list)
  uri:
    url: "http://app:8080/api/provider-instances"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: provider_instances_api

- name: Set provider_instance_id if not already set
  set_fact:
    provider_instance_id: "{{ (provider_instances_api.json.instances | selectattr('name','equalto','E2E GitLab') | list)[0].id }}"
  when: provider_instance_id is not defined

- name: Fetch employees page to find test employee id
  uri:
    url: "http://app:8080/employees"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
    return_content: yes
  register: employees_page_for_id

- name: Store employees HTML
  set_fact:
    employees_html: "{{ (employees_page_for_id | default({})).get('content', (employees_page_for_id | default({})).get('body', '')) }}"

- name: Extract test employee id from employees HTML
  set_fact:
    test_employee_id: >-
      {{ (employees_html | default('') | regex_findall('(?s)data-employee-id="(emp_[0-9_]+)".*?test@example.com') | first)
         | default(employees_html | default('') | regex_findall('(?s)test@example.com.*?data-employee-id="(emp_[0-9_]+)"') | first)
         | default('') }}

- name: Assert test employee id extracted
  assert:
    that:
      - test_employee_id is defined
      - test_employee_id != ''

- name: Assign a git asset to the test employee using provider instance
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "{{ provider_instance_id }}"
      asset_identifier: "e2e_user"
      asset_type: "git"
    status_code: 200
  register: assign_response

- name: Assert assignment succeeded
  debug:
    var: assign_response.json

- name: Assert assignment succeeded
  assert:
    that:
      - assign_response.json.success == true

- name: Assign a GitLab repository to the test employee
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "{{ provider_instance_id }}"
      asset_identifier: "1"  # Assuming project ID 1
      asset_type: "repository"
    status_code: 200
  register: repo_assign_response

- name: Assert repository assignment succeeded
  assert:
    that:
      - repo_assign_response.json.success == true

- name: Set keycloak provider_instance_id
  set_fact:
    keycloak_provider_instance_id: "{{ (provider_instances_api.json.instances | selectattr('name','equalto','E2E Keycloak') | list)[0].id }}"
  when: keycloak_provider_instance_id is not defined

- name: Assign a Keycloak account to the test employee
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "{{ keycloak_provider_instance_id }}"
      asset_identifier: "e2e_keycloak_user"
      asset_type: "iam"
    status_code: 200
  register: keycloak_assign_response

- name: Assert Keycloak assignment succeeded and password returned
  assert:
    that:
      - keycloak_assign_response.json.success == true
      - keycloak_assign_response.json.password is defined
      - keycloak_assign_response.json.password | length > 0

- name: Set telegram provider_instance_id
  set_fact:
    telegram_provider_instance_id: "{{ (provider_instances_api.json.instances | selectattr('name','equalto','E2E Telegram') | list)[0].id }}"
  when: telegram_provider_instance_id is not defined

- name: Assign a Telegram chat to the test employee
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "{{ telegram_provider_instance_id }}"
      asset_identifier: "@testchat"
      asset_type: "messenger"
    status_code: 200
  register: telegram_assign_response

- name: Assert Telegram assignment succeeded
  assert:
    that:
      - telegram_assign_response.json.success == true

- name: Set mailcow provider_instance_id
  set_fact:
    mailcow_provider_instance_id: "{{ (provider_instances_api.json.instances | selectattr('name','equalto','E2E Mailcow') | list)[0].id }}"
  when: mailcow_provider_instance_id is not defined

- name: Assign a Mailcow mailbox to the test employee
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "{{ mailcow_provider_instance_id }}"
      asset_identifier: "e2euser@defaultcorp.com"
      asset_type: "email"
    status_code: 200
  register: mailcow_assign_response

- name: Assert Mailcow assignment succeeded and password returned
  assert:
    that:
      - mailcow_assign_response.json.success == true
      - mailcow_assign_response.json.password is defined
      - mailcow_assign_response.json.password | length > 0

- name: Assign a Mailcow alias to the test employee
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "{{ mailcow_provider_instance_id }}"
      asset_identifier: "alias@defaultcorp.com"
      asset_type: "alias"
    status_code: 200
  register: alias_assign_response

- name: Assert alias assignment succeeded
  assert:
    that:
      - alias_assign_response.json.success == true

- name: Fetch assigned assets via API for employee
  uri:
    url: "http://app:8080/api/employee-assets?employee_id={{ test_employee_id }}"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: employee_assets_api

- name: Assert assigned asset present in employee assets API
  assert:
    that:
      - employee_assets_api.status == 200
      - employee_assets_api.json.success == true
      - (employee_assets_api.json.assets | selectattr('identifier','equalto','e2e_user') | list) | length > 0

- name: Set assigned_asset_id fact
  set_fact:
    assigned_asset_id: "{{ (employee_assets_api.json.assets | selectattr('identifier','equalto','e2e_user') | list)[0].id }}"

- name: Fetch assets page and assert assigned git account is visible (page OR API)
  uri:
    url: "http://app:8080/assets"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
    return_content: yes
  register: assets_page_after_assign

- name: Debug assets page excerpt
  debug:
    msg: "Assets page excerpt: {{ (assets_page_after_assign.content | default(''))[:800] }}"

- name: Debug assigned git accounts block
  debug:
    msg: "Assigned Git block matches: {{ (assets_page_after_assign.content | default('')) | regex_findall('(?s)<h4>Assigned Git Accounts</h4>.*?<\/table>') | length }}"

- name: Debug search for raw identifier
  debug:
    msg: "Found raw e2e_user: {{ (assets_page_after_assign.content | default('')) | regex_search('e2e_user') }}"

- name: Assert assigned asset appears in assets page or in API
  assert:
    that:
      - assets_page_after_assign.status == 200
      - ((assets_page_after_assign.content | default('')) | regex_search('e2e_user')) or ((employee_assets_api.json.assets | selectattr('identifier','equalto','e2e_user') | list) | length > 0)

- name: Fetch assigned assets via API for employee
  uri:
    url: "http://app:8080/api/employee-assets?employee_id={{ test_employee_id }}"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: employee_assets_api

- name: Assert assigned asset present in employee assets API
  assert:
    that:
      - employee_assets_api.status == 200
      - employee_assets_api.json.success == true
      - (employee_assets_api.json.assets | selectattr('identifier','equalto','e2e_user') | list) | length > 0

- name: Set assigned_asset_id fact
  set_fact:
    assigned_asset_id: "{{ (employee_assets_api.json.assets | selectattr('identifier','equalto','e2e_user') | list)[0].id }}"

- name: Unassign the asset
  uri:
    url: "http://app:8080/assets/unassignAsset"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      asset_id: "{{ assigned_asset_id }}"
    status_code: 200
  register: unassign_response

- name: Assert unassign succeeded
  assert:
    that:
      - unassign_response.json.success == true

- name: Verify asset no longer present in employee assets API
  uri:
    url: "http://app:8080/api/employee-assets?employee_id={{ test_employee_id }}"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: employee_assets_api_after_unassign

- name: Assert asset removed
  assert:
    that:
      - (employee_assets_api_after_unassign.json.assets | selectattr('identifier','equalto','e2e_user') | list) | length == 0

# Negative scenarios: missing fields and invalid provider instance
- name: Attempt assign with missing fields (should error)
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "{{ provider_instance_id }}"
      asset_type: "git"
    status_code: 200
  register: assign_missing_fields

- name: Assert missing fields error returned
  assert:
    that:
      - assign_missing_fields.json.success == false

- name: Attempt assign with invalid provider_instance_id (should error)
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "prov_invalid_123"
      asset_identifier: "bad_user"
      asset_type: "git"
    status_code: 200
  register: assign_invalid_prov

- name: Assert invalid provider instance error
  assert:
    that:
      - assign_invalid_prov.json.success == false
