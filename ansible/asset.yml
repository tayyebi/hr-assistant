---
- name: Get assets page
  uri:
    url: "http://app:8080/assets"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: assets_page

- name: Assert assets page loaded
  assert:
    that:
      - assets_page.status == 200

- name: Ensure provider instance id is available (fetch list)
  uri:
    url: "http://app:8080/api/provider-instances"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: provider_instances_api

- name: Set provider_instance_id if not already set
  set_fact:
    provider_instance_id: "{{ (provider_instances_api.json.instances | selectattr('name','equalto','E2E GitLab') | list)[0].id }}"
  when: provider_instance_id is not defined

- name: Fetch employees page to find test employee id
  uri:
    url: "http://app:8080/employees"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
    return_content: yes
  register: employees_page_for_id

- name: Store employees HTML
  set_fact:
    employees_html: "{{ (employees_page_for_id | default({})).get('content', (employees_page_for_id | default({})).get('body', '')) }}"

- name: Extract test employee id from employees HTML
  set_fact:
    test_employee_id: >-
      {{ (employees_html | default('') | regex_findall('(?s)data-employee-id="(emp_[0-9_]+)".*?test@example.com') | first)
         | default(employees_html | default('') | regex_findall('(?s)test@example.com.*?data-employee-id="(emp_[0-9_]+)"') | first)
         | default('') }}

- name: Assert test employee id extracted
  assert:
    that:
      - test_employee_id is defined
      - test_employee_id != ''

- name: Assign a git asset to the test employee using provider instance
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "{{ provider_instance_id }}"
      asset_identifier: "e2e_user"
      asset_type: "git"
    status_code: 200
  register: assign_response

- name: Assert assignment succeeded
  debug:
    var: assign_response.json

- name: Assert assignment succeeded
  assert:
    that:
      - assign_response.json.success == true

- name: Fetch assets page and assert assigned git account is visible
  uri:
    url: "http://app:8080/assets"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
    return_content: yes
  register: assets_page_after_assign

- name: Assert assigned asset appears in assets page
  debug:
    msg: "Assets page excerpt: {{ (assets_page_after_assign.content | default(''))[:800] }}"

- name: Debug assigned git accounts block
  debug:
    msg: "{{ (assets_page_after_assign.content | default('')) | regex_findall('(?s)<h4>Assigned Git Accounts</h4>.*?<\/table>') | first }}"

- name: Debug search for raw identifier
  debug:
    msg: "Found raw e2e_user: {{ (assets_page_after_assign.content | default('')) | regex_search('e2e_user') }}"

- name: Assert assigned asset appears in assets page
  assert:
    that:
      - assets_page_after_assign.status == 200
      - (assets_page_after_assign.content | default('')) | regex_search('e2e_user')
