---
- name: Get assets page
  uri:
    url: "http://app:8080/assets"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: assets_page

- name: Assert assets page loaded
  assert:
    that:
      - assets_page.status == 200

- name: Ensure provider instance id is available (fetch list)
  uri:
    url: "http://app:8080/api/provider-instances"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: provider_instances_api

- name: Set provider_instance_id if not already set
  set_fact:
    provider_instance_id: "{{ (provider_instances_api.json.instances | selectattr('name','equalto','E2E GitLab') | list)[0].id }}"
  when: provider_instance_id is not defined

- name: Get created test employee id from DB
  shell: docker exec -i hr-assistant-mockdb-1 mysql -u root -ptest -N -e "USE hr_assistant_test; SELECT id FROM employees WHERE email = 'test@example.com' LIMIT 1;"
  register: employee_id_raw

- name: Trim employee id
  set_fact:
    test_employee_id: "{{ employee_id_raw.stdout | trim }}"

- name: Assign a git asset to the test employee using provider instance
  uri:
    url: "http://app:8080/assets/assign"
    method: POST
    headers:
      Cookie: "{{ cookie_header }}"
      Content-Type: "application/x-www-form-urlencoded"
    body_format: form-urlencoded
    body:
      employee_id: "{{ test_employee_id }}"
      provider_instance_id: "{{ provider_instance_id }}"
      asset_identifier: "e2e_user"
      asset_type: "git"
    status_code: 200
  register: assign_response

- name: Assert assignment succeeded
  assert:
    that:
      - assign_response.json.success == true

- name: Fetch assets page and assert assigned git account is visible
  uri:
    url: "http://app:8080/assets"
    method: GET
    headers:
      Cookie: "{{ cookie_header }}"
    status_code: 200
  register: assets_page_after_assign

- name: Assert assigned asset appears in assets page
  assert:
    that:
      - assets_page_after_assign.status == 200
      - assets_page_after_assign.content | regex_search('e2e_user')
