---
- name: Run all E2E playbooks
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    app_url: "http://app:8080"
    admin_email: "admin@defaultcorp.com"
    admin_password: "password"
    sysadmin_email: "sysadmin@corp.com"
    sysadmin_password: "password"

  tasks:
    # Authentication tests
    - name: Run authentication tests
      include_tasks: auth.yml

    # Login for subsequent tests
    - name: Login as tenant admin for subsequent tests
      uri:
        url: "{{ app_url }}/login"
        method: POST
        body_format: form-urlencoded
        body:
          email: "{{ admin_email }}"
          password: "{{ admin_password }}"
        follow_redirects: none
        status_code: 302
      register: auth_login

    - name: Store session cookie
      set_fact:
        auth_cookie: "{{ auth_login.set_cookie }}"

    - name: Debug session cookie
      debug:
        var: auth_cookie

    # Employee tests with authentication
    - name: Run employee tests
      include_tasks: employee.yml
      vars:
        cookie_header: "{{ auth_cookie }}"

    # Team tests with authentication
    - name: Run team tests
      include_tasks: team.yml
      vars:
        cookie_header: "{{ auth_cookie }}"

    # Message tests with authentication
    - name: Run message tests
      include_tasks: message.yml
      vars:
        cookie_header: "{{ auth_cookie }}"

    # Job tests with authentication
    - name: Run job tests
      include_tasks: job.yml
      vars:
        cookie_header: "{{ auth_cookie }}"

    # Settings tests with authentication
    - name: Run settings tests
      include_tasks: settings.yml
      vars:
        cookie_header: "{{ auth_cookie }}"

    # Asset tests with authentication
    - name: Run asset tests
      include_tasks: asset.yml
      vars:
        cookie_header: "{{ auth_cookie }}"

    # Login as system admin for admin tests
    - name: Login as system admin
      uri:
        url: "{{ app_url }}/login"
        method: POST
        body_format: form-urlencoded
        body:
          email: "{{ sysadmin_email }}"
          password: "{{ sysadmin_password }}"
        follow_redirects: none
        status_code: 302
      register: sysadmin_login

    - name: Store sysadmin session cookie
      set_fact:
        sysadmin_cookie: "{{ sysadmin_login.set_cookie }}"

    # Admin tests with sysadmin authentication
    - name: Run admin tests
      include_tasks: admin.yml
      vars:
        cookie_header: "{{ sysadmin_cookie }}"
