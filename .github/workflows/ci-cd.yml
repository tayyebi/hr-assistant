name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# Minimum permissions required for the workflow
permissions:
  contents: read

jobs:
  lint:
    name: PHP Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: composer:v2

      - name: Validate composer.json
        run: composer validate --strict

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: PHP Syntax Check
        run: find . -type f -name "*.php" ! -path "./vendor/*" -exec php -l {} \;

  test:
    name: PHP Tests
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, zip
          tools: composer:v2

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Create data directory
        run: mkdir -p data

      - name: Run basic smoke test
        run: |
          php -r "
          require 'vendor/autoload.php';
          require 'app/core/Database.php';
          echo 'Database helper loaded successfully\n';
          "

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, zip
          tools: composer:v2

      - name: Install production dependencies
        run: composer install --prefer-dist --no-dev --optimize-autoloader

      - name: Create data directory
        run: mkdir -p data

      - name: Create deployment artifact
        run: |
          tar -czf hr-assistant.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='*.tsx' \
            --exclude='*.ts' \
            --exclude='vite.config.ts' \
            --exclude='tsconfig.json' \
            --exclude='package.json' \
            --exclude='package-lock.json' \
            --exclude='index.html' \
            --exclude='App.tsx' \
            --exclude='index.tsx' \
            --exclude='components' \
            --exclude='pages' \
            --exclude='services' \
            --exclude='types.ts' \
            .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hr-assistant-build
          path: hr-assistant.tar.gz
          retention-days: 7

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    permissions: {}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: hr-assistant-build

      - name: Extract artifact
        run: tar -xzf hr-assistant.tar.gz

      - name: Deploy to staging server
        run: |
          echo "Deploying to staging environment..."
          echo "In a real deployment, this would:"
          echo "1. SSH to staging server or use cloud provider CLI"
          echo "2. Upload files to web server document root"
          echo "3. Run database migrations if needed"
          echo "4. Clear caches"
          echo "5. Restart PHP-FPM if needed"
          echo ""
          echo "For example with rsync:"
          echo "rsync -avz --delete ./ user@staging.example.com:/var/www/hr-assistant/"
          echo ""
          echo "Or with AWS:"
          echo "aws s3 sync ./ s3://staging-bucket/ --delete"
          echo "aws cloudfront create-invalidation --distribution-id \$CDN_ID --paths '/*'"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    permissions: {}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: hr-assistant-build

      - name: Extract artifact
        run: tar -xzf hr-assistant.tar.gz

      - name: Deploy to production server
        run: |
          echo "Deploying to production environment..."
          echo "In a real deployment, this would:"
          echo "1. SSH to production server or use cloud provider CLI"
          echo "2. Create backup of current deployment"
          echo "3. Upload files to web server document root"
          echo "4. Run database migrations if needed"
          echo "5. Clear caches"
          echo "6. Restart PHP-FPM if needed"
          echo "7. Verify deployment health"
          echo ""
          echo "Example deployment commands:"
          echo "# Create backup"
          echo "ssh user@prod.example.com 'tar -czf /backups/hr-assistant-\$(date +%Y%m%d%H%M%S).tar.gz /var/www/hr-assistant'"
          echo ""
          echo "# Deploy"
          echo "rsync -avz --delete ./ user@prod.example.com:/var/www/hr-assistant/"
          echo ""
          echo "# Restart services"
          echo "ssh user@prod.example.com 'sudo systemctl restart php-fpm'"
